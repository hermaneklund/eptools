<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>E&P Förvaltning Dashboard</title>
    <link rel="stylesheet" href="/static/style.css?v=2" />
  </head>
  <body>
    <div class="sidebar-backdrop" id="sidebar-backdrop"></div>
    <aside class="sidebar" id="sidebar">
      <nav class="sidebar-nav">
        <a href="/" class="sidebar-link">Portfolio Viewer</a>
        <a href="/mina-kunder" class="sidebar-link">Mina kunder</a>
        <a href="/mandat" class="sidebar-link">Mandat</a>
        <div class="sidebar-group">
          <button type="button" class="sidebar-link sidebar-toggle" data-target="fixed-income-subnav">
            Fixed Income <span class="caret">&#9662;</span>
          </button>
          <div class="sidebar-subnav" id="fixed-income-subnav">
            <a href="/fixed-income" class="sidebar-link">Kassapositioner</a>
            <a href="/fixed-income-innehav" class="sidebar-link">Innehav</a>
          </div>
        </div>
        <div class="sidebar-group">
          <button type="button" class="sidebar-link sidebar-toggle" data-target="portfoljhantering-subnav">
            Portföljhantering <span class="caret">▾</span>
          </button>
          <div class="sidebar-subnav" id="portfoljhantering-subnav">
            <a href="/ombalansering" class="sidebar-link">Ombalansering</a>
            <a href="/modulforandring" class="sidebar-link">Positionstorlek</a>
            <a href="/taggar" class="sidebar-link">Taggar</a>
          </div>
        </div>
        <div class="sidebar-group">
          <button type="button" class="sidebar-link sidebar-toggle" data-target="forvaltning-subnav">
            Förvaltning <span class="caret">▾</span>
          </button>
          <div class="sidebar-subnav" id="forvaltning-subnav">
            <a href="/dashboard" class="sidebar-link">Dashboard</a>
            <a href="/core-sverige" class="sidebar-link">Core Sverige</a>
            <a href="/edge" class="sidebar-link">Edge</a>
            <a href="/alternativa" class="sidebar-link">Alternativa</a>
            <a href="/core-varlden" class="sidebar-link">Core Världen</a>
          </div>
        </div>
        <div class="sidebar-spacer"></div>
        <form class="sidebar-form sidebar-import" method="post" action="/import" enctype="multipart/form-data">
          <label class="sidebar-upload-button">
            <input type="file" name="excel_file" accept=".xlsx,.xlsm,.xls" class="sidebar-file-input-hidden" required />
            Välj Excel-fil
          </label>
          <button type="submit" class="sidebar-button">Importera Excel</button>
        </form>
        <form class="sidebar-form sidebar-import" method="get" action="/db/export">
          <button type="submit" class="sidebar-button">Exportera DB</button>
        </form>
        <div class="sidebar-meta sidebar-import">Senast importerat: {{ last_import() }}</div>
      </nav>
    </aside>

    <main class="page">
      <div class="logo-wrap">
        <a href="/" aria-label="Go to Portfolio Viewer">
          <img src="/static/eplogo.png" alt="Ericsson & Partners logo" class="logo" />
        </a>
      </div>
      <header class="header">
        <button class="menu-button" id="menu-button" aria-label="Open menu" type="button">
          <span class="menu-label">Menu</span>
          <span></span>
          <span></span>
          <span></span>
        </button>
      </header>

      <section class="sheet">
        <div class="table-wrap">
          <table class="dashboard-perf-table">
            <thead>
              <tr>
                <th class="perf-label-col">Performance YTD</th>
                {% for row in ytd_rows %}
                  <th class="perf-model-col">{{ row.Model }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="perf-label-col">Modul</td>
                {% for row in ytd_rows %}
                  <td class="perf-model-col">{% if row.ModelYTD is not none %}{{ format_percent_1(row.ModelYTD) }}{% endif %}</td>
                {% endfor %}
              </tr>
              <tr>
                <td class="perf-label-col">Index</td>
                {% for row in ytd_rows %}
                  {% set idx = row.Index1YTD if row.Index1YTD is not none else row.Index2YTD %}
                  <td class="perf-model-col">{% if idx is not none %}{{ format_percent_1(idx) }}{% endif %}</td>
                {% endfor %}
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="sheet">
        <div class="model-donut-grid">
          {% for table in model_tables %}
            <div class="donut-panel">
              <div id="dashboard-donut-{{ loop.index0 }}" style="height:300px; width:100%;"></div>
            </div>
          {% endfor %}
        </div>
      </section>

      <section class="sheet">
        <div class="dash-card">
          <div class="sidebar-meta" style="margin-bottom:8px;">Weekly/YTD senast hämtat: {{ perf_last_fetched }}</div>
          <div class="model-dashboard-grid">
            {% for table in model_tables %}
              <div class="table-wrap">
                <table class="dashboard-holdings-table">
                  <thead>
                    <tr>
                      <th colspan="5">{{ table.title }}</th>
                    </tr>
                    <tr>
                      <th>Innehav</th>
                      <th>Utv.</th>
                      <th>Weekly</th>
                      <th>YTD</th>
                      <th>Vikt</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in table.rows %}
                      <tr>
                        <td>{{ row.Holding }}</td>
                        {% set utv_cls = "dashboard-num-pos" if row.Utv is not none and row.Utv > 0.10 else ("dashboard-num-neg" if row.Utv is not none and row.Utv < -0.10 else "") %}
                        <td class="{{ utv_cls }}">{{ format_percent_1(row.Utv) }}</td>
                        {% set weekly_cls = "dashboard-num-pos" if row.WeeklyPerf is not none and row.WeeklyPerf > 0.10 else ("dashboard-num-neg" if row.WeeklyPerf is not none and row.WeeklyPerf < -0.10 else "") %}
                        <td class="{{ weekly_cls }}">{% if row.WeeklyPerf is not none %}{{ format_percent_1(row.WeeklyPerf) }}{% endif %}</td>
                        {% set ytd_cls = "dashboard-num-pos" if row.YTDPerf is not none and row.YTDPerf > 0.10 else ("dashboard-num-neg" if row.YTDPerf is not none and row.YTDPerf < -0.10 else "") %}
                        <td class="{{ ytd_cls }}">{% if row.YTDPerf is not none %}{{ format_percent_1(row.YTDPerf) }}{% endif %}</td>
                        <td>{{ format_percent_1(row.Vikt) }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% endfor %}
          </div>
        </div>
      </section>

      <div class="dashboard-actions">
        <form method="post" action="/models-update">
          <button type="submit" class="sidebar-button">Uppdatera modeller</button>
        </form>
      </div>
    </main>

    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script>
      const sidebar = document.getElementById("sidebar");
      const backdrop = document.getElementById("sidebar-backdrop");
      const menuButton = document.getElementById("menu-button");
      const openSidebar = () => {
        sidebar.classList.add("open");
        backdrop.classList.add("show");
      };
      const closeSidebar = () => {
        sidebar.classList.remove("open");
        backdrop.classList.remove("show");
      };
      menuButton.addEventListener("click", () => {
        if (sidebar.classList.contains("open")) closeSidebar();
        else openSidebar();
      });
      backdrop.addEventListener("click", closeSidebar);
      const sidebarToggles = document.querySelectorAll(".sidebar-toggle");
      sidebarToggles.forEach((toggle) => {
        const targetId = toggle.dataset.target;
        const subnav = document.getElementById(targetId);
        if (!subnav) return;
        toggle.addEventListener("click", () => {
          subnav.classList.toggle("open");
        });
      });

      const donutModels = {{ model_tables | tojson }};
      const donutPalette = [
        "#005F02",
        "#427A43",
        "#629FAD",
        "#C0B87A",
        "#F2E3BB",
        "#296374",
        "#0C2C55",
        "#EDEDCE",
        "#5A9CB5",
        "#41644A",
        "#9E3B3B",
        "#D25353",
        "#EA7B7B",
        "#FFEAD3"
      ];
      const chartColors = ["#005F02", "#0C2C55", "#D25353", "#C0B87A"];
      donutModels.forEach((model, idx) => {
        const target = document.getElementById(`dashboard-donut-${idx}`);
        if (!target) return;
        const points = Array.isArray(model.donut_points) ? model.donut_points : [];
        const sorted = [...points].sort((a, b) => Number(b.value || 0) - Number(a.value || 0));
        const labelsFull = sorted.map(p => String(p.label || ""));
        const labels = labelsFull.map(v => v.length > 8 ? v.slice(0, 8) : v);
        const values = sorted.map(p => Number(p.value || 0));
        if (!labels.length) {
          target.innerHTML = '<div style="color:#6b7280;font-size:13px;padding:28px 0;text-align:center;">Inga innehav</div>';
          return;
        }
        Plotly.newPlot(target, [{
          type: "bar",
          x: labels,
          y: values,
          customdata: labelsFull,
          marker: { color: chartColors[idx % chartColors.length] },
          hovertemplate: "%{customdata}<br>%{y:.1%}<extra></extra>"
        }], {
          margin: { l: 58, r: 16, t: 20, b: 92 },
          showlegend: false,
          title: { text: model.title, x: 0.5, xanchor: "center", y: 0.98, font: { size: 12, color: "#334155" } },
          xaxis: { tickangle: -35, tickfont: { size: 10 } },
          yaxis: { tickformat: ".0%", rangemode: "tozero" },
          paper_bgcolor: "rgba(0,0,0,0)",
          plot_bgcolor: "rgba(0,0,0,0)"
        }, { displayModeBar: false, responsive: true });
      });
    </script>
  </body>
</html>
