<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>E&P Portfolio Viewer - Fixed Income Innehav</title>
    <link rel="stylesheet" href="/static/style.css?v=2" />
    <link rel="icon" href="/static/epicon.png" type="image/png" />
  </head>
  <body>
    <div class="sidebar-backdrop" id="sidebar-backdrop"></div>
    <aside class="sidebar" id="sidebar">
      <nav class="sidebar-nav">
        <a href="/" class="sidebar-link">Portfolio Viewer</a>
        <a href="/mina-kunder" class="sidebar-link">Mina kunder</a>
        <a href="/mandat" class="sidebar-link">Mandat</a>
        <div class="sidebar-group">
          <button type="button" class="sidebar-link sidebar-toggle" data-target="fixed-income-subnav">
            Fixed Income <span class="caret">&#9662;</span>
          </button>
          <div class="sidebar-subnav" id="fixed-income-subnav">
            <a href="/fixed-income" class="sidebar-link">Kassapositioner</a>
            <a href="/fixed-income-innehav" class="sidebar-link">Innehav</a>
          </div>
        </div>
        <div class="sidebar-group">
          <button type="button" class="sidebar-link sidebar-toggle" data-target="portfoljhantering-subnav">
            Portföljhantering <span class="caret">▾</span>
          </button>
          <div class="sidebar-subnav" id="portfoljhantering-subnav">
            <a href="/ombalansering" class="sidebar-link">Ombalansering</a>
            <a href="/modulforandring" class="sidebar-link">Positionstorlek</a>
            <a href="/uppbyggnader" class="sidebar-link">Uppbyggnader</a>
            <a href="/taggar" class="sidebar-link">Taggar</a>
          </div>
        </div>
        <div class="sidebar-group">
          <button type="button" class="sidebar-link sidebar-toggle" data-target="forvaltning-subnav">
            Förvaltning <span class="caret">▾</span>
          </button>
          <div class="sidebar-subnav" id="forvaltning-subnav">
            <a href="/dashboard" class="sidebar-link">Dashboard</a>
            <a href="/core-sverige" class="sidebar-link">Core Sverige</a>
            <a href="/edge" class="sidebar-link">Edge</a>
            <a href="/alternativa" class="sidebar-link">Alternativa</a>
            <a href="/core-varlden" class="sidebar-link">Core Världen</a>
          </div>
        </div>
        <div class="sidebar-spacer"></div>
        <form class="sidebar-form sidebar-import" method="post" action="/import" enctype="multipart/form-data">
          <label class="sidebar-upload-button">
            <input type="file" name="excel_file" accept=".xlsx,.xlsm,.xls" class="sidebar-file-input-hidden" required />
            Välj Excel-fil
          </label>
          <button type="submit" class="sidebar-button">Importera Excel</button>
        </form>
        <form class="sidebar-form sidebar-import" method="get" action="/db/export">
          <button type="submit" class="sidebar-button">Exportera DB</button>
        </form>
        <div class="sidebar-meta sidebar-import">Senast importerat: {{ last_import() }}</div>
      </nav>
    </aside>
    <main class="page">
      <div class="logo-wrap">
        <a href="/" aria-label="Go to Portfolio Viewer">
          <img src="/static/eplogo.png" alt="Ericsson & Partners logo" class="logo" />
        </a>
      </div>
      <header class="header">
        <button class="menu-button" id="menu-button" aria-label="Open menu" type="button">
          <span class="menu-label">Menu</span>
          <span></span>
          <span></span>
          <span></span>
        </button>
      </header>

      <section class="sheet fixed-income-main">
        <div class="sheet-header-row" style="margin-bottom: 12px;">
          <h2>Fixed Income</h2>
          <form method="get" action="/fixed-income-innehav" style="display:flex; align-items:center; gap:8px;">
            <label for="stibor-input" style="font-size:12px; color:#475569;">Stibor</label>
            <input
              id="stibor-input"
              type="text"
              name="stibor"
              value="{{ stibor }}"
              placeholder="t.ex. 3,25%"
              style="width:96px; height:30px; border:1px solid #d1d5db; border-radius:8px; padding:0 8px; font-size:12px;"
            />
            <button
              type="submit"
              aria-label="Sätt stibor"
              title="Sätt stibor"
              style="width:30px; height:30px; border:1px solid #d1d5db; border-radius:999px; background:#ffffff; color:#0f172a; font-size:13px; line-height:1; cursor:pointer;"
            >✓</button>
          </form>
        </div>
        {% if rows and rows|length > 0 %}
          <div class="table-wrap fixed-income-table">
            <table>
              <thead>
                <tr>
                  {% for col in columns %}
                    <th>{{ col }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for row in rows %}
                  <tr>
                    {% for col in columns %}
                      <td>{{ format_cell(col, row[col]) }}</td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="empty" style="margin-top: 12px;">Inga data.</p>
        {% endif %}

        {% if rows and rows|length > 0 %}
          <div class="fi-innehav-charts">
            <div class="dash-card">
              <div class="dash-title">Sektorfördelning</div>
              <div id="fi-sector-chart" style="height:320px;"></div>
            </div>
            <div class="dash-card">
              <div class="dash-title">Yieldfördelning</div>
              <div id="fi-yield-chart" style="height:320px;"></div>
            </div>
          </div>
        {% endif %}
      </section>
    </main>

    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script>
      const sidebar = document.getElementById("sidebar");
      const backdrop = document.getElementById("sidebar-backdrop");
      const menuButton = document.getElementById("menu-button");

      const openSidebar = () => {
        sidebar.classList.add("open");
        backdrop.classList.add("show");
      };

      const closeSidebar = () => {
        sidebar.classList.remove("open");
        backdrop.classList.remove("show");
      };

      menuButton.addEventListener("click", () => {
        if (sidebar.classList.contains("open")) {
          closeSidebar();
        } else {
          openSidebar();
        }
      });

      backdrop.addEventListener("click", closeSidebar);
      const sidebarToggles = document.querySelectorAll(".sidebar-toggle");
      sidebarToggles.forEach((toggle) => {
        const targetId = toggle.dataset.target;
        const subnav = document.getElementById(targetId);
        if (!subnav) return;
        toggle.addEventListener("click", () => {
          subnav.classList.toggle("open");
        });
      });

      const sectorPoints = {{ sector_points|safe }};
      const yieldDeciles = {{ yield_decile_points|safe }};
      const weightedAvgYield = {{ weighted_avg_yield if weighted_avg_yield is not none else 'null' }};

      const sectorEl = document.getElementById("fi-sector-chart");
      if (sectorEl && sectorPoints && sectorPoints.length) {
        const palette = [
          "#0C2C55",
          "#296374",
          "#629FAD",
          "#EDEDCE",
          "#005F02",
          "#427A43",
          "#C0B87A",
          "#F2E3BB",
          "#2D6A2E",
          "#6A8E5A",
          "#D8CCA0",
          "#0B6B16",
          "#5B8B46",
          "#A89D5C",
          "#E7D39E",
          "#356F3A",
          "#7D9558",
          "#BFAF6C",
          "#F0DEB0",
          "#1F5E24",
          "#8A7D44",
          "#DCCB8A",
          "#9E3B3B",
          "#D25353",
          "#EA7B7B",
          "#FFEAD3",
          "#1F4E79",
          "#2F6A8F",
          "#3F86A6",
          "#5CA4BF",
          "#6F8C5A",
          "#87A06B",
          "#9FB47D",
          "#B8C88F",
          "#6B4E71",
          "#836289",
          "#9A77A0",
          "#B28CB7",
          "#7A5A3A",
          "#92704D",
          "#AA8661",
          "#C29C74",
          "#335C67",
          "#4A7681",
          "#61909B",
          "#78AAB5",
        ];
        const used = new Set();
        const uniqueColors = sectorPoints.map((_, i) => {
          if (i < palette.length) {
            used.add(palette[i].toLowerCase());
            return palette[i];
          }
          // Guaranteed unique fallback via golden-angle hue walk with varying lightness.
          let step = i - palette.length;
          let color = "";
          do {
            const hue = (step * 137.508) % 360;
            const lightness = 42 + (step % 4) * 6;
            color = `hsl(${hue.toFixed(3)}, 48%, ${lightness}%)`;
            step += 1;
          } while (used.has(color));
          used.add(color);
          return color;
        });
        Plotly.newPlot(
          sectorEl,
          [{
            type: "pie",
            hole: 0.55,
            labels: sectorPoints.map((p) => p.label),
            values: sectorPoints.map((p) => p.value),
            sort: false,
            direction: "clockwise",
            rotation: 360,
            marker: { colors: uniqueColors, line: { width: 0 } },
            textinfo: "none",
            hovertemplate: "%{label}<br>%{percent:.0%}<extra></extra>",
          }],
          {
            margin: { t: 10, r: 10, b: 10, l: 10 },
            showlegend: true,
            legend: { orientation: "v", x: 1.02, y: 0.5, xanchor: "left", yanchor: "middle" },
            paper_bgcolor: "rgba(0,0,0,0)",
            plot_bgcolor: "rgba(0,0,0,0)",
          },
          { displayModeBar: false, responsive: true }
        );
      }

      const yieldEl = document.getElementById("fi-yield-chart");
      if (yieldEl && yieldDeciles && yieldDeciles.length) {
        const maxY = Math.max(...yieldDeciles.map((p) => Number(p.value || 0)), 0);
        const avgX = weightedAvgYield === null ? null : (
          weightedAvgYield < 0.03 ? "<3%" :
          weightedAvgYield < 0.04 ? "3-4%" :
          weightedAvgYield < 0.05 ? "4-5%" :
          weightedAvgYield < 0.06 ? "5-6%" :
          weightedAvgYield < 0.07 ? "6-7%" :
          weightedAvgYield < 0.08 ? "7-8%" : ">8%"
        );
        Plotly.newPlot(
          yieldEl,
          [{
            type: "bar",
            x: yieldDeciles.map((p) => p.label),
            y: yieldDeciles.map((p) => p.value),
            marker: { color: "#41644A" },
            hovertemplate: "%{x}<br>%{y:,.0f} SEK<extra></extra>",
          }],
          {
            margin: { t: 10, r: 10, b: 35, l: 60 },
            xaxis: { title: "" },
            yaxis: { title: "" },
            showlegend: false,
            shapes: (avgX && maxY > 0) ? [{
              type: "line",
              xref: "x",
              yref: "y",
              x0: avgX,
              x1: avgX,
              y0: 0,
              y1: maxY,
              line: { color: "#334155", width: 2, dash: "dot" },
            }] : [],
            annotations: (avgX && maxY > 0) ? [{
              x: avgX,
              y: maxY,
              xref: "x",
              yref: "y",
              text: `VWAY ${ (weightedAvgYield * 100).toFixed(1).replace('.', ',') }%`,
              showarrow: false,
              yshift: 8,
              font: { size: 11, color: "#334155" },
            }] : [],
            paper_bgcolor: "rgba(0,0,0,0)",
            plot_bgcolor: "rgba(0,0,0,0)",
          },
          { displayModeBar: false, responsive: true }
        );
      }
    </script>
  </body>
</html>
