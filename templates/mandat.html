<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>E&P Portfolio Viewer - Mandat</title>
    <link rel="stylesheet" href="/static/style.css?v=2" />
  </head>
  <body>
    <div class="sidebar-backdrop" id="sidebar-backdrop"></div>
    <aside class="sidebar" id="sidebar">
      <nav class="sidebar-nav">
        <a href="/" class="sidebar-link">Portfolio Viewer</a>
        <a href="/taggar" class="sidebar-link">Taggar</a>
        <a href="/mandat" class="sidebar-link">Mandat</a>
        <a href="/fixed-income" class="sidebar-link">Fixed Income</a>
        <a href="/ombalansering" class="sidebar-link">Ombalansering</a>
        <a href="/modulforandring" class="sidebar-link">Positionstorlek</a>
        <div class="sidebar-group">
          <button type="button" class="sidebar-link sidebar-toggle" data-target="forvaltning-subnav">
            Förvaltning <span class="caret">▾</span>
          </button>
          <div class="sidebar-subnav" id="forvaltning-subnav">
            <a href="/core-sverige" class="sidebar-link">Core Sverige</a>
            <a href="/edge" class="sidebar-link">Edge</a>
            <a href="/alternativa" class="sidebar-link">Alternativa</a>
            <a href="/core-varlden" class="sidebar-link">Core Världen</a>
          </div>
        </div>
        <div class="sidebar-spacer"></div>
        <form class="sidebar-form sidebar-import" method="post" action="/models-update">
          <button type="submit" class="sidebar-button">Uppdatera modeller</button>
        </form>
                        <form class="sidebar-form sidebar-import" method="post" action="/import" enctype="multipart/form-data">
          <label class="sidebar-upload-button">
            <input type="file" name="excel_file" accept=".xlsx,.xlsm,.xls" class="sidebar-file-input-hidden" required />
            Välj Excel-fil
          </label>
          <button type="submit" class="sidebar-button">Importera Excel</button>
        </form>


        <div class="sidebar-meta sidebar-import">Senast importerat: {{ last_import() }}</div>
      </nav>
    </aside>
    <main class="page">
      <div class="logo-wrap">
        <a href="/" aria-label="Go to Portfolio Viewer">
          <img src="/static/eplogo.png" alt="Ericsson & Partners logo" class="logo" />
        </a>
      </div>
      <header class="header">
        <button class="menu-button" id="menu-button" aria-label="Open menu" type="button">
          <span class="menu-label">Menu</span>
          <span></span>
          <span></span>
          <span></span>
        </button>
      </header>

      <form class="search" method="get" action="/mandat">
        <input
          type="text"
          name="q"
          value="{{ q }}"
          list="mandat-number-suggestions"
          autocomplete="off"
        />
        <button type="submit">Search</button>
      </form>
      <datalist id="mandat-number-suggestions">
        {% for item in number_suggestions %}
          <option value="{{ item }}"></option>
        {% endfor %}
      </datalist>

      <section class="sheet">
        <div class="sheet-header-row">
          <h2>Mandatöversikt</h2>
          <div class="table-actions-right">
            <a class="sidebar-button table-export" href="/mandat/export{% if q %}?q={{ q }}{% endif %}">Exportera Excel</a>
          </div>
        </div>
        {% if rows and rows|length > 0 %}
          <form method="post" action="/mandat-save-row" class="mandat-form">
            <div class="table-actions">
            </div>
            <div class="table-wrap mandat-table" id="mandat-table-wrap">
              <table>
                <thead>
                  <tr>
                    <th></th>
                    {% for col in columns %}
                      <th class="{% if loop.index0 >= (columns|length - 4) %}narrow-col{% endif %}{% if col == 'FI' or col in ['dynamisk','coresv','corevä','edge','alts'] %} fi-col{% endif %}">
                        {% if col == "Number" %}
                          <a class="sort-arrow{% if sort_by == 'number' %} active{% endif %}" href="/mandat?sort_by=number{% if q %}&q={{ q }}{% endif %}">
                            {{ col }} <span>↓</span>
                          </a>
                        {% elif col == "FI" %}
                          <a class="sort-arrow{% if sort_by == 'fi' %} active{% endif %}" href="/mandat?sort_by=fi{% if q %}&q={{ q }}{% endif %}">
                            {{ col }} <span>↓</span>
                          </a>
                        {% else %}
                          {{ col }}
                        {% endif %}
                      </th>
                    {% endfor %}
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <tr class="mandat-new">
                    <td class="table-actions-cell">
                      <span class="new-icon">＋</span>
                    </td>
                    {% for col in columns %}
                      {% set editable = loop.index0 < 23 or loop.index0 >= (columns|length - 4) or col in ["dynamisk", "coresv", "corevä", "edge", "alts", "RG7>25", "20%", "Akt>75", "Akt>25", "Alt>50", "Rä != 0", "Alt!= 0", "Placeringsriktlinjer"] %}
                      {% set is_bool = col in ["dynamisk", "coresv", "corevä", "edge", "alts", "RG7>25", "20%", "Akt>75", "Akt>25", "Alt>50", "Rä != 0", "Alt!= 0", "Placeringsriktlinjer"] %}
                      <td class="{% if loop.index0 >= (columns|length - 4) %}narrow-col{% endif %}{% if col == 'FI' or col in ['dynamisk','coresv','corevä','edge','alts'] %} fi-col{% endif %}">
                        {% if editable %}
                          <span class="new-placeholder">{{ col }}</span>
                          {% if is_bool %}
                            <input type="checkbox" name="{{ col }}" value="1" form="mandat-add-form" class="new-input" />
                          {% else %}
                            <input type="text" name="{{ col }}" placeholder="Ny {{ col }}" form="mandat-add-form" class="new-input" />
                          {% endif %}
                        {% endif %}
                      </td>
                    {% endfor %}
                    <td class="table-actions-cell">
                      <button type="submit" class="taggar-add" formaction="/mandat-add" formmethod="post" form="mandat-add-form">Lägg till</button>
                    </td>
                  </tr>
                  {% for row in rows %}
                    {% if row.get("_row_class") == "spacer-row" %}
                      <tr class="spacer-row">
                        <td colspan="{{ columns|length + 2 }}"></td>
                      </tr>
                    {% elif row.get("_row_class") == "section-row" %}
                      <tr class="section-row">
                        <td colspan="{{ columns|length + 2 }}">{{ row.get("_label", "") }}</td>
                      </tr>
                    {% else %}
                    <tr class="mandat-row">
                      <td class="table-actions-cell">
                        <button type="button" class="taggar-edit mandat-edit">✎</button>
                        <button type="submit" class="taggar-save-row mandat-save-row" name="row_id" value="{{ row['_row_key'] }}" data-rowkey="{{ row['_row_key'] }}">Spara</button>
                      </td>
                      {% for col in columns %}
                        <td class="{% if loop.index0 >= (columns|length - 4) %}narrow-col{% endif %}{% if col == 'FI' or col in ['dynamisk','coresv','corevä','edge','alts'] %} fi-col{% endif %}">
                          {% set editable = loop.index0 < 23 or loop.index0 >= (columns|length - 4) or col in ["dynamisk", "coresv", "corevä", "edge", "alts", "RG7>25", "20%", "Akt>75", "Akt>25", "Alt>50", "Rä != 0", "Alt!= 0", "Placeringsriktlinjer"] %}
                          {% set is_bool = col in ["dynamisk", "coresv", "corevä", "edge", "alts", "RG7>25", "20%", "Akt>75", "Akt>25", "Alt>50", "Rä != 0", "Alt!= 0", "Placeringsriktlinjer"] %}
                          {% if is_bool %}
                            <input
                              type="checkbox"
                              name="row__{{ row['_row_key'] }}__{{ col }}"
                              value="1"
                              {% if row[col] in [1, "1", True, "True", "true"] %}checked{% endif %}
                              class="cell-edit"
                              {% if not editable %}disabled{% endif %}
                            />
                            <span class="cell-readonly">{{ format_cell(col, row[col]) }}</span>
                          {% else %}
                            {% if col == "Number" %}
                              <span class="cell-readonly"><a href="/?q={{ row[col] }}" class="number-link">{{ format_cell(col, row[col]) }}</a></span>
                            {% else %}
                              <span class="cell-readonly">{{ format_cell(col, row[col]) }}</span>
                            {% endif %}
                            {% if editable %}
                              <input
                                type="text"
                                name="row__{{ row['_row_key'] }}__{{ col }}"
                                value="{{ row[col] }}"
                                class="cell-edit"
                                disabled
                              />
                            {% endif %}
                          {% endif %}
                        </td>
                      {% endfor %}
                      <td class="table-actions-cell">
                        <button type="submit" class="taggar-delete" formaction="/mandat-delete" formmethod="post" name="row_id" value="{{ row['_row_key'] }}" data-rowkey="{{ row['_row_key'] }}">Ta bort</button>
                      </td>
                    </tr>
                    {% endif %}
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </form>
          <form id="mandat-add-form" method="post" action="/mandat-add"></form>
        {% else %}
          <p class="empty">Inga data.</p>
        {% endif %}
      </section>

      <div class="mandat-actions" style="margin-top:8px;margin-bottom:24px;display:flex;justify-content:flex-end;gap:12px;align-items:center;">
        <form method="get" action="/mandat#compliance" style="margin:0;">
          <input type="hidden" name="compliance" value="1" />
          {% if q %}
            <input type="hidden" name="q" value="{{ q }}" />
          {% endif %}
          <button type="submit" class="sidebar-button">Compliance Test</button>
        </form>
        <a class="sidebar-button" href="/mandat/compliance-export{% if q %}?q={{ q }}{% endif %}">Exportera Excel</a>
      </div>

      {% if compliance %}
        <section class="sheet" id="compliance">
          <h2>Compliance Report</h2>
          {% if compliance_rows and compliance_rows|length > 0 %}
            <div class="table-wrap compliance-table-wrap">
              <table class="compliance-table">
                <thead>
                  <tr>
                    <th>Number</th>
                    <th>Kund</th>
                    <th>Mandat</th>
                    <th>Mandatnotering</th>
                    <th>Rule</th>
                    <th>Anledning</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in compliance_rows %}
                    <tr>
                      <td>{{ row.Number }}</td>
                      <td>{{ row.Kund }}</td>
                      <td>{{ row.Mandat }}</td>
                      <td class="mandatnotering-cell">{{ row.Mandatnotering }}</td>
                      <td>{{ row.Rule }}</td>
                      <td>{{ row.Innehav }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="empty">Inga avvikelser.</p>
          {% endif %}
        </section>
      {% endif %}
    </main>

    <script>
      const sidebar = document.getElementById("sidebar");
      const backdrop = document.getElementById("sidebar-backdrop");
      const menuButton = document.getElementById("menu-button");

      const openSidebar = () => {
        sidebar.classList.add("open");
        backdrop.classList.add("show");
      };

      const closeSidebar = () => {
        sidebar.classList.remove("open");
        backdrop.classList.remove("show");
      };

      menuButton.addEventListener("click", () => {
        if (sidebar.classList.contains("open")) {
          closeSidebar();
        } else {
          openSidebar();
        }
      });

      backdrop.addEventListener("click", closeSidebar);

      const forvaltningToggle = document.querySelector(".sidebar-toggle");
      if (forvaltningToggle) {
        const targetId = forvaltningToggle.dataset.target;
        const target = document.getElementById(targetId);
        forvaltningToggle.addEventListener("click", () => {
          if (target) {
            target.classList.toggle("open");
          }
        });
      }

      const input = document.querySelector('input[name="q"]');
      const datalist = document.getElementById("mandat-number-suggestions");
      const allNumbers = {{ number_suggestions | tojson }};

      const renderOptions = (items) => {
        datalist.innerHTML = "";
        items.forEach((value) => {
          const option = document.createElement("option");
          option.value = value;
          datalist.appendChild(option);
        });
      };

      renderOptions(allNumbers);

      input.addEventListener("input", () => {
        const value = input.value.trim();
        if (!value) {
          renderOptions(allNumbers);
          return;
        }
        const filtered = allNumbers.filter((num) => String(num).startsWith(value));
        renderOptions(filtered);
      });

      const tableWrap = document.getElementById("mandat-table-wrap");
      const mandatRows = document.querySelectorAll(".mandat-row");
      mandatRows.forEach((row) => {
        const editBtn = row.querySelector(".mandat-edit");
        const saveBtn = row.querySelector(".mandat-save-row");
        const inputs = row.querySelectorAll(".cell-edit");
        const readonly = row.querySelectorAll(".cell-readonly");
        const dynamisk = row.querySelector('input[name$="__dynamisk"]');
        const autoBoxes = [
          row.querySelector('input[name$="__coresv"]'),
          row.querySelector('input[name$="__corevä"]'),
          row.querySelector('input[name$="__edge"]'),
          row.querySelector('input[name$="__alts"]')
        ].filter(Boolean);

        const setEditing = (isEditing) => {
          row.classList.toggle("editing", isEditing);
          inputs.forEach((input) => {
            input.disabled = !isEditing;
          });
          readonly.forEach((el) => {
            el.style.display = isEditing ? "none" : "inline-block";
          });
        };

        setEditing(false);

        if (editBtn) {
          editBtn.addEventListener("click", () => {
            setEditing(true);
            const first = row.querySelector(".cell-edit");
            if (first) first.focus();
          });
        }

        if (dynamisk) {
          dynamisk.addEventListener("change", () => {
            if (dynamisk.checked) {
              autoBoxes.forEach((box) => {
                if (!box.disabled) {
                  box.checked = true;
                }
              });
            }
          });
        }

        if (saveBtn) {
          saveBtn.addEventListener("click", () => {
            if (tableWrap) {
              sessionStorage.setItem("mandatScrollTop", String(tableWrap.scrollTop));
            }
          });
        }
      });

      const restoreTop = sessionStorage.getItem("mandatScrollTop");
      if (restoreTop && tableWrap) {
        sessionStorage.removeItem("mandatScrollTop");
        tableWrap.scrollTop = Number(restoreTop);
      }

    </script>
  </body>
</html>
